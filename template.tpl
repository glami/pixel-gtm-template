___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "displayName": "GLAMI piXel",
  "description": "GLAMI piXel is the tracking code that unlocks personalization in GLAMI catalogue and assists in delivering better results to e-shops.",
  "categories": [
    "CONVERSION_TRACKING",
    "PERSONALIZATION"
  ],
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,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",
    "displayName": "glami",
    "id": "github.com_glami"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "notSetText": "API key value is mandatory.",
    "help": "Unique identifier",
    "valueValidators": [
      {
        "args": [
          32,
          32
        ],
        "errorMessage": "API must be exactly 32 chars long.",
        "type": "STRING_LENGTH"
      }
    ],
    "displayName": "API key",
    "simpleValueType": true,
    "name": "apiKey",
    "type": "TEXT"
  },
  {
    "help": "Glami domain identifier - ISO 3166-1 alpha-2 code",
    "displayName": "Country code",
    "simpleValueType": true,
    "name": "countryCode",
    "type": "TEXT",
    "notSetText": "Country code value is mandatory."
  },
  {
    "type": "TEXT",
    "name": "consent",
    "displayName": "Cookie consent value",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "DECIMAL",
        "enablingConditions": []
      }
    ],
    "valueHint": "Consent given (1) or not given (0).",
    "help": "User consent to the storage of analytical cookies on their devices. Set 1 in case the user gave permission. Otherwise set 0 for \"no\"."
  },
  {
    "macrosInSelect": false,
    "selectItems": [
      {
        "displayValue": "PageView",
        "value": "PageView"
      },
      {
        "displayValue": "ViewContent",
        "value": "ViewContent"
      },
      {
        "value": "AddToCart",
        "displayValue": "AddToCart"
      },
      {
        "value": "Transaction",
        "displayValue": "Transaction"
      }
    ],
    "displayName": "Track type",
    "defaultValue": "PageView",
    "simpleValueType": true,
    "name": "trackType",
    "type": "SELECT"
  },
  {
    "displayName": "Transaction variables",
    "name": "transaction",
    "groupStyle": "ZIPPY_OPEN",
    "type": "GROUP",
    "subParams": [
      {
        "displayName": "Values of transaction variables are usually provided using dataLayer.",
        "name": "TransactionVariablesGroupTitle",
        "type": "LABEL"
      },
      {
        "help": "Unique transaction identifier",
        "displayName": "Transaction ID",
        "simpleValueType": true,
        "name": "transactionId",
        "type": "TEXT"
      },
      {
        "help": "Order total value",
        "displayName": "Order value",
        "simpleValueType": true,
        "name": "orderValue",
        "type": "TEXT"
      },
      {
        "help": "ISO 4217 currency code (EUR, USD, CZK)",
        "displayName": "Order currency",
        "simpleValueType": true,
        "name": "currency",
        "type": "TEXT"
      },
      {
        "help": "Names of bought products. Multiple values are separated by comma (,). Preferably use the same names as in your Glami product feed.",
        "displayName": "Product names",
        "simpleValueType": true,
        "name": "productNames",
        "type": "TEXT"
      },
      {
        "help": "IDs of bought products. Multiple values are separated by comma (,). Preferably use the same IDs as in your Glami product feed.",
        "displayName": "Product IDs",
        "simpleValueType": true,
        "name": "productIds",
        "type": "TEXT"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "trackType",
        "paramValue": "Transaction",
        "type": "EQUALS"
      }
    ]
  },
  {
    "displayName": "AddToCart variables",
    "name": "AddToCartVariablesGrouptransaction",
    "groupStyle": "ZIPPY_OPEN",
    "type": "GROUP",
    "subParams": [
      {
        "displayName": "Values of AddToCart variables are usually provided using dataLayer.",
        "name": "addToCartVariablesGroupTitle",
        "type": "LABEL"
      },
      {
        "help": "IDs of products added into cart. Multiple values are separated by comma (,). Preferably use the same IDs as in your Glami product feed.",
        "displayName": "Product IDs",
        "simpleValueType": true,
        "name": "addToCartProductIds",
        "type": "TEXT"
      },
      {
        "help": "Names of products added into cart. Multiple values are separated by comma (,). Preferably use the same names as in your Glami product feed.",
        "displayName": "Product names",
        "simpleValueType": true,
        "name": "addToCartProductNames",
        "type": "TEXT"
      },
      {
        "help": "Product price",
        "displayName": "Product price (optional)",
        "simpleValueType": true,
        "name": "addToCartProductPrice",
        "type": "TEXT"
      },
      {
        "help": "ISO 4217 currency code (EUR, USD, CZK)",
        "displayName": "Product price currency (optional)",
        "simpleValueType": true,
        "name": "addToCartCurrency",
        "type": "TEXT"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "trackType",
        "paramValue": "AddToCart",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "ViewContentVariablesGroup",
    "displayName": "ViewContent variables",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "LABEL",
        "name": "ViewContentVariablesGroupTitle",
        "displayName": "Values of ViewContent variables are usually provided using dataLayer."
      },
      {
        "type": "SELECT",
        "name": "contentType",
        "displayName": "Content type",
        "selectItems": [
          {
            "value": "product",
            "displayValue": "Product"
          },
          {
            "value": "category",
            "displayValue": "Category"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "product"
      },
      {
        "type": "TEXT",
        "name": "viewContentProductIds",
        "displayName": "Product IDs",
        "simpleValueType": true,
        "help": "IDs of viewed products. Multiple values are separated by comma (,). Preferably use the same IDs as in your Glami product feed."
      }
    ],
    "enablingConditions": [
      {
        "paramName": "trackType",
        "paramValue": "ViewContent",
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const injectScript = require('injectScript');
const callInWindow = require('callInWindow');
const log = require('logToConsole');
const set = require('setInWindow');
const createArgumentsQueue = require('createArgumentsQueue');
const getType = require('getType');
const makeInteger = require('makeInteger');

let glamiObject = function () {
  createArgumentsQueue('glami', 'glamiObject.q');
};

set('GlamiTrackerObject', 'glami');
set('glami', glamiObject);

const onSuccess = function () {
  
  let consent = 1;
  if (data.consent !== undefined && makeInteger(data.consent) === 0) {
    consent = 0;
  }
  
  callInWindow('glami', 'create', data.apiKey, data.countryCode, null, {source: 'gtm', consent: consent});
  
  if (data.trackType === 'PageView') {
  	callInWindow('glami', 'track', 'PageView');  
  }
  
  if (data.trackType === 'Transaction') {
    let eventValues = {};
    if (data.orderValue) {
        eventValues.value = data.orderValue;
    }
    if (data.currency) {
        eventValues.currency = data.currency;
    }
    if (data.productNames) {
		if (getType(data.productNames) === 'array') {
          	eventValues.product_names = data.productNames;
        } else {
			eventValues.product_names = stringToArray(data.productNames);
        }
    }
    // transaction products
    if (data.productIds) {
        if (getType(data.productIds) === 'array') {
			eventValues.item_ids = data.productIds;
        } else {
			eventValues.item_ids = stringToArray(data.productIds);
        }
    }
    
    if (data.transactionId) {
        eventValues.transaction_id = data.transactionId;
    }
    
  	callInWindow('glami', 'track', 'Purchase', eventValues);
  }
  
  if (data.trackType === 'ViewContent') {
    let eventValues = {};
    
    if (data.contentType) {
        eventValues.content_type = data.contentType;
    }
    
    // view content products
    if (data.viewContentProductIds) {
        if (getType(data.viewContentProductIds) === 'array') {
			eventValues.item_ids = data.viewContentProductIds;
        } else {
			eventValues.item_ids = stringToArray(data.viewContentProductIds);
        }
    }
    
    callInWindow('glami', 'track', 'ViewContent', eventValues);
  }
  
  if (data.trackType === 'AddToCart') {
    let eventValues = {};
    
    // add to cart products
    if (data.addToCartProductIds) {
        if (getType(data.addToCartProductIds) === 'array') {
			eventValues.item_ids = data.addToCartProductIds;
        } else {
			eventValues.item_ids = stringToArray(data.addToCartProductIds);
        }
    }
    
    if (data.addToCartProductPrice) {
        eventValues.value = data.addToCartProductPrice;
    }
    if (data.addToCartCurrency) {
        eventValues.currency = data.addToCartCurrency;
    }
    if (data.addToCartProductNames) {
		if (getType(data.addToCartProductNames) === 'array') {
          	eventValues.product_names = data.addToCartProductNames;
        } else {
			eventValues.product_names = stringToArray(data.addToCartProductNames);
        }
    }
    
    callInWindow('glami', 'track', 'AddToCart', eventValues);
  }
    
  
  data.gtmOnSuccess();
};

const onFailure = function () {
  log('Error loading Glami pixel code.');
  
  data.gtmOnFailure();
};

// removes falsy values from array
const stringToArray = function (strValue) {
  return ('' + strValue).split(',').map(function(el) { return el.trim(); }).filter(function(el) { return el; });
};

injectScript('https://glamipixel.com/js/compiled/pt.js', onSuccess, onFailure);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "glami"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "GlamiTrackerObject"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "glami.q"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://glamipixel.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 04/09/2019, 08:31:19
